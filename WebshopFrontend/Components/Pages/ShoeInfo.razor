@page "/ShoeInfo/{id:int}"
@using Microsoft.AspNetCore.Components.Authorization
@using WebshopFrontend.Components.MyComponents
@using WebshopLibrary
@using WebshopLibrary.DTOs
@rendermode InteractiveServer
@inject IHttpClientFactory HttpClientFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject CartService CartService
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage


<div class="info-container">
	<div class="currency-container">
		<CurrencyComponent CurrencyChanged="Exchange"/>
	</div>
	@if (shoe != null)
	{
		var price = Math.Round(shoe.Price * _rate, 2);
		var salePrice = Math.Round(price * 0.7m * _rate, 2);
		if (shoe.OnSale)
		{
			<div class="img-div">
				<img src=@shoe.ImgUrl>
			</div>
			<div class="text-div">
				<h1>@shoe.Brand</h1>
				<h2>@shoe.Name</h2>
				<p>In Store: @shoe.Quantity</p>
				<p>Color: @shoe.Color</p>
				<p>Size: @shoe.Size</p>
				<p class="old-price">@price @_currency</p>
				<h2 class="sale-price">@salePrice @_currency</h2>
				@if (shoe.Quantity > 0)
				{
					<button class="add-shoe-btn" @onclick="() => AddShoeToCart(shoe)">Push to cart</button>
				}
				else
				{
					<button class="sold-out-btn">Sold Out</button>
				}
			</div>
		}
		else
		{
			<div class="img-div">
				<img src=@shoe.ImgUrl>
			</div>
			<div class="text-div">
				<h1>@shoe.Brand</h1>
				<h2>@shoe.Name</h2>
				<p>In Store: @shoe.Quantity</p>
				<p>Color: @shoe.Color</p>
				<p>Size: @shoe.Size</p>
				<p>@price @_currency</p>
				@if (shoe.Quantity > 0)
				{
					<button class="add-shoe-btn" @onclick="() => AddShoeToCart(shoe)">Push to cart</button>
				}
				else
				{
					<button class="sold-out-btn">Sold Out</button>
				}
			</div>
		}
	}
</div>

@code {
	[Parameter] public int id { get; set; }

	private ShoeDTO? shoe;
	private AuthenticationState? _authState;
	private bool _isLoggedIn = false;
	private string _user = "Guest";

	private string? _currency;
	private decimal _rate = 1m;

	private async Task FetchShoe()
	{
		using var client = HttpClientFactory.CreateClient("MyApi");
		shoe = await client.GetFromJsonAsync<ShoeDTO>($"/shoes/{id}");
	}

	protected override async Task OnInitializedAsync()
	{
		await FetchShoe();
		_isLoggedIn = await CheckRegisteredUser();
		if (_isLoggedIn)
		{
			_user = _authState?.User?.Identity?.Name;
		}
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (!firstRender) return;
		_currency = await LocalStorage.GetItemAsync<string>("currency") ?? "SEK";
		await Exchange(_currency);
		StateHasChanged();
	}

	private async Task AddShoeToCart(ShoeDTO shoe)
	{
		using var client = HttpClientFactory.CreateClient("MyApi");
		await CartService.AddShoeToCart(_user, shoe, client);
		await FetchShoe();
	}

	private async Task<bool> CheckRegisteredUser()
	{
		_authState = await AuthStateProvider.GetAuthenticationStateAsync();
		return _authState?.User?.Identity?.IsAuthenticated ?? false;
	}

	public async Task Exchange(string currency)
	{
		using var client = HttpClientFactory.CreateClient("MyApi");
		var response = await client.GetFromJsonAsync<ExchangeRateDTO>("/exchange");
		var rates = response.ConversionRates;

		if (rates != null)
		{
			_rate = rates[currency];
			_currency = currency;
			StateHasChanged();
		}
	}

}
